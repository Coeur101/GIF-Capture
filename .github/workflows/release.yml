name: Electron Zip Release

on:
  push:
    tags:
      - "v*"

jobs:
  release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install deps
        run: pnpm install --no-frozen-lockfile

      - name: Ensure ffmpeg-static binary is downloaded
        run: |
          echo "Rebuilding ffmpeg-static to ensure binary download..."
          pnpm rebuild ffmpeg-static
        shell: pwsh

      - name: Verify ffmpeg-static installation
        run: |
          echo "Checking ffmpeg-static installation..."
          if (Test-Path "node_modules/ffmpeg-static/ffmpeg.exe") {
            echo "✓ ffmpeg.exe found"
            Get-Item "node_modules/ffmpeg-static/ffmpeg.exe"
          } else {
            echo "✗ ffmpeg.exe NOT found"
            echo "Contents of node_modules/ffmpeg-static:"
            Get-ChildItem "node_modules/ffmpeg-static" -ErrorAction SilentlyContinue
          }
        shell: pwsh

      - name: Build and publish
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: pnpm run electron:build
