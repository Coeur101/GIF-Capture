name: Electron Zip Release

on:
  push:
    tags:
      - "v*"

jobs:
  release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install deps
        run: pnpm install --no-frozen-lockfile

      - name: Download FFmpeg binary
        run: |
          echo "Downloading FFmpeg binary for Windows x64..."
          $ffmpegDir = "node_modules/ffmpeg-static"

          # 从 ffmpeg-static 的 GitHub releases 下载预编译的 Windows 二进制文件
          $ffmpegUrl = "https://github.com/eugeneware/ffmpeg-static/releases/download/b6.0/ffmpeg-win32-x64"
          $ffmpegExe = "$ffmpegDir/ffmpeg.exe"

          echo "Downloading from: $ffmpegUrl"
          echo "Target: $ffmpegExe"

          Invoke-WebRequest -Uri $ffmpegUrl -OutFile $ffmpegExe

          if (Test-Path $ffmpegExe) {
            echo "✓ FFmpeg downloaded successfully"
            $fileInfo = Get-Item $ffmpegExe
            echo "File size: $($fileInfo.Length) bytes"
          } else {
            echo "✗ Failed to download FFmpeg"
            exit 1
          }
        shell: pwsh

      - name: Verify ffmpeg-static installation
        run: |
          echo "Verifying FFmpeg installation..."
          if (Test-Path "node_modules/ffmpeg-static/ffmpeg.exe") {
            echo "✓ ffmpeg.exe found"
            Get-Item "node_modules/ffmpeg-static/ffmpeg.exe"
          } else {
            echo "✗ ffmpeg.exe NOT found"
            exit 1
          }
        shell: pwsh

      - name: Build and publish
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: pnpm run electron:build
